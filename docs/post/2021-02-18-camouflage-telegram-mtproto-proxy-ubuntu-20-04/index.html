<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>How to Build a Camouflaged Telegram MTProto Proxy Server on Ubuntu 20.04 - v2how</title>
  <meta name="description" content="Introduction Telegram Messenger supports two kinds of proxies: a standard SOCKS5 proxy server and an MTProto proxy server.
In this post you&rsquo;ll learn how to build a camouflaged MTProto proxy server. This style of proxy can help you bypass censorship in certain countries.
By following along, you&rsquo;ll see how to create an Nginx camouflage web server and a hidden MTProto proxy server that implements the fake TLS protocol on the same host as the web server.">
  <meta name="author" content="Amy"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "v2how",
    
    "url": "https:\/\/v2how.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/v2how.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/v2how.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/v2how.github.io\/post\/2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04\/",
          "name": "How to build a camouflaged telegram m t proto proxy server on ubuntu 20.04"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Amy"
  },
  "headline": "How to Build a Camouflaged Telegram MTProto Proxy Server on Ubuntu 20.04",
  "description" : "Introduction Telegram Messenger supports two kinds of proxies: a standard SOCKS5 proxy server and an MTProto proxy server.\nIn this post you\u0026rsquo;ll learn how to build a camouflaged MTProto proxy server. This style of proxy can help you bypass censorship in certain countries.\nBy following along, you\u0026rsquo;ll see how to create an Nginx camouflage web server and a hidden MTProto proxy server that implements the fake TLS protocol on the same host as the web server.",
  "inLanguage" : "en",
  "wordCount":  3070 ,
  "datePublished" : "2021-02-18T00:00:00",
  "dateModified" : "2021-02-18T00:00:00",
  "image" : "https:\/\/v2how.github.io\/images\/amy-avatar-icon.png",
  "keywords" : [ "telegram, mtproto, server, ubuntu" ],
  "mainEntityOfPage" : "https:\/\/v2how.github.io\/post\/2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/v2how.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/v2how.github.io\/images\/amy-avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="How to Build a Camouflaged Telegram MTProto Proxy Server on Ubuntu 20.04" />
<meta property="og:description" content="Introduction Telegram Messenger supports two kinds of proxies: a standard SOCKS5 proxy server and an MTProto proxy server.
In this post you&rsquo;ll learn how to build a camouflaged MTProto proxy server. This style of proxy can help you bypass censorship in certain countries.
By following along, you&rsquo;ll see how to create an Nginx camouflage web server and a hidden MTProto proxy server that implements the fake TLS protocol on the same host as the web server.">
<meta property="og:image" content="https://v2how.github.io/images/amy-avatar-icon.png" />
<meta property="og:url" content="https://v2how.github.io/post/2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="v2how" />

  <meta name="twitter:title" content="How to Build a Camouflaged Telegram MTProto Proxy Server on Ubuntu …" />
  <meta name="twitter:description" content="Introduction Telegram Messenger supports two kinds of proxies: a standard SOCKS5 proxy server and an MTProto proxy server.
In this post you&rsquo;ll learn how to build a camouflaged MTProto proxy …">
  <meta name="twitter:image" content="https://v2how.github.io/images/amy-avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://v2how.github.io/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.80.0" />
  <link rel="alternate" href="https://v2how.github.io/index.xml" type="application/rss+xml" title="v2how"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://v2how.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://v2how.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://v2how.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<script async src="https://www.googletagmanager.com/gtag/js?id=G-SW1P8SGNST"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SW1P8SGNST');
</script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://v2how.github.io">v2how</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="v2how" href="https://v2how.github.io">
            <img class="avatar-img" src="https://v2how.github.io/images/amy-avatar-icon.png" alt="v2how" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>How to Build a Camouflaged Telegram MTProto Proxy Server on Ubuntu 20.04</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on February 18, 2021
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;15&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;3070&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Amy
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <h3 id="introduction">Introduction</h3>
<p>Telegram Messenger supports two kinds of proxies: a standard SOCKS5 proxy server and an MTProto proxy server.</p>
<p>In this post you&rsquo;ll learn how to build a camouflaged MTProto proxy server. This style of proxy can help you bypass censorship in certain countries.</p>
<p>By following along, you&rsquo;ll see how to create an Nginx camouflage web server and a hidden MTProto proxy server that implements the fake TLS protocol on the same host as the web server. Casual visitors to the server will see only a website.</p>
<p>At the end of this tutorial, you&rsquo;ll have a working and tested MTProto proxy server and a secret you can share with your friends.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Before you begin this tutorial, you will need:</p>
<ul>
<li>A virtual private server (VPS) running Ubuntu 20.04. You can rent servers from providers such as <a href="https://cloud.google.com">Google Cloud</a> or <a href="https://www.vultr.com">Vultr</a>. This server needs to be located in a country that does not block Telegram Messenger.</li>
<li>Your own domain name, which may be <a href="https://www.freenom.com">free</a> or <a href="https://www.namesilo.com">paid</a>.</li>
<li>A DNS type <code>A</code> record pointing from the fully qualified domain name of your server to the server&rsquo;s IP address. Usually you set up the DNS record at your domain name registrar.</li>
</ul>
<h2 id="step-1--logging-in-as-root">Step 1 — Logging In as Root</h2>
<p>SSH into your server. On Linux and macOS, you can use the terminal command <code>ssh</code> to reach your server. On Windows, you can either use <a href="https://docs.microsoft.com/en-us/powershell">PowerShell</a> or a graphical user interface (GUI) such as <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty">PuTTY</a> or <a href="https://www.netsarang.com">XSHELL</a>.</p>
<p>If you&rsquo;re not logged in as <code>root</code>, then become <code>root</code> as follows. If you don&rsquo;t already know the root password, then set it by issuing the command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo passwd root
</code></pre></div><p>The <code>sudo</code> command allows non-root users to issue root commands. The <code>passwd</code> command allows you to set the password for yourself or another user, which in this case is the user named <code>root</code>.</p>
<p>You are prompted to enter your own password:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> amy:
</code></pre></div><p>Enter your own (non-root) password.</p>
<p>You are then prompted to enter a new password for the user <code>root</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">New password:
</code></pre></div><p>Choose and enter the new password for <code>root</code>.</p>
<p>You are prompted to confirm the new password by retyping it:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Retype new password:
</code></pre></div><p>Enter the same new password for <code>root</code>.</p>
<p>If all is well, you will receive a feedback message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">passwd: password updated successfully
</code></pre></div><p>Now you know the root password, become <code>root</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">su -
</code></pre></div><p>The <code>su</code> command (short for switch user) allows you to switch to another user id, so that you can run commands with that user&rsquo;s privileges. Since no specific user is named, you will by default switch to the user <code>root</code>.  The hyphen (<code>-</code>) means create a new login environment for the new user, which will be completely separate from your existing login environment.</p>
<p>You are prompted to enter the password for <code>root</code> that you set a few moments ago:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Password:
</code></pre></div><p>Enter the root password.</p>
<p>You will notice that your command prompt changes from a dollar sign to a hash sign:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#</span>
</code></pre></div><p>This is a reminder that your are logged in as <code>root</code>. Now that you are <code>root</code>, you do not need to prefix privileged commands with <code>sudo</code>.</p>
<p>Update your package lists, and upgrade all your packages to the latest version:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</code></pre></div><p>You will see package upgrade messages in your terminal.</p>
<h2 id="step-2--enabling-the-firewall-optional">Step 2 — Enabling the Firewall (Optional)</h2>
<p>We recommend that you protect your server and especially port <code>22</code> (the SSH port) by installing a firewall. In this tutorial, you&rsquo;ll install and configure the uncomplicated firewall (<code>ufw</code>).</p>
<p>On many Ubuntu systems, <code>ufw</code> is already installed. Check that <code>ufw</code> is installed on your system:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt list ufw
</code></pre></div><p>You should see a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw/focal,now 0.36-6 all <span class="o">[</span>installed<span class="o">]</span>
</code></pre></div><p>If you do not see the message stating that <code>ufw</code> is already installed, then install the software package now:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt install ufw
</code></pre></div><p>Now you&rsquo;ll set up the firewall. If you can guarantee that you will always SSH into your server from a single IP address, then limit SSH access to just that single address. For example, if your IP address is <code>12.12.12.12</code>, then issue the command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw allow from 12.12.12.12/32 to any port <span class="m">22</span> proto tcp
</code></pre></div><p>When you execute that command, you will see a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Rule added
</code></pre></div><p>If limiting access to a single IP address is not possible, but you can guarantee you will always connect from a known IP address range, then limit SSH access to just that range. For example, if you are in an office which always uses the IP address range <code>12.12.12.0/24</code>, then issue the command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw allow from 12.12.12.0/24 to any port <span class="m">22</span> proto tcp
</code></pre></div><p>If limiting access to an IP address range is not possible, then you will have to open the SSH port for access from the entire world:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw allow ssh
</code></pre></div><p>In any case, we recommend that you further protect port <code>22</code> by using SSH key authentication in preference to password authentication. SSH key pair generation and upload to your server are out of scope for this tutorial. You can find tutorials on this subject on the web.</p>
<p>Open ports <code>80</code> (the HTTP port) and <code>443</code> (the HTTPS port). These will be used for the Nginx camouflage web server:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw allow http

ufw allow https
</code></pre></div><p>Also open port <code>993</code> for cloaking:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw allow to any port <span class="m">993</span> proto tcp
</code></pre></div><p>Enable UFW:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw <span class="nb">enable</span>
</code></pre></div><p>You will see a warning message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Command may disrupt existing ssh connections. Proceed with operation <span class="o">(</span>y<span class="p">|</span>n<span class="o">)</span>?
</code></pre></div><p>Type <code>Y</code> and press <code>ENTER</code> to confirm that you wish to enable <code>ufw</code>. You will see a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Firewall is active and enabled on system startup
</code></pre></div><p>Check the status of your firewall:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ufw status
</code></pre></div><p>You will see a firewall status display that looks like the following:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       12.12.12.0/24
80/tcp                     ALLOW       Anywhere
443/tcp                    ALLOW       Anywhere
993/tcp                    ALLOW       Anywhere
80/tcp <span class="o">(</span>v6<span class="o">)</span>                ALLOW       Anywhere <span class="o">(</span>v6<span class="o">)</span>
443/tcp <span class="o">(</span>v6<span class="o">)</span>               ALLOW       Anywhere <span class="o">(</span>v6<span class="o">)</span>
</code></pre></div><p>If your VPS provider implements the concept of security groups, you will also need to open your security group assignments for ports <code>22</code>, <code>80</code>, <code>443</code>, and <code>993</code> in their control panel.</p>
<h2 id="step-3--creating-a-camouflage-website">Step 3 — Creating a Camouflage Website</h2>
<p>Now you&rsquo;ll install Nginx and obtain an SSL certificate. The purpose of Nginx is to camouflage your MTProto proxy server.</p>
<p>Install the Nginx web server package:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt install nginx -y
</code></pre></div><p>If Nginx was not already installed, you will see the package installation messages.</p>
<p>Edit the default virtual host configuration file, <code>/etc/nginx/sites-available/default</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano /etc/nginx/sites-available/default
</code></pre></div><p>Find the line containing <code>server_name _;</code>. Change it so that it refers to the fully qualified domain name of your server:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">        server_name your_domain<span class="p">;</span>
</code></pre></div><p>Write the file out to disk, and exit the editor.</p>
<p>Restart Nginx with your revised configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">systemctl restart nginx
</code></pre></div><p>You will use <code>snap</code> to install <code>certbot</code>, the Let&rsquo;s Encrypt client. First install the <code>core</code> snap:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">snap install core
</code></pre></div><p>After the snap is installed, you will see a confirmation message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">core 16-2.48.2.1 from Canonical✓ installed
</code></pre></div><p>Get the <code>core</code> snap up to date if necessary:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">snap refresh core
</code></pre></div><p>Since <code>core</code> is already up to date, you should see a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">snap <span class="s2">&#34;core&#34;</span> has no updates available
</code></pre></div><p>Now use snap to install the <code>certbot</code> client for Let&rsquo;s Encrypt:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">snap install --classic certbot
</code></pre></div><p>The <code>--classic</code> option means that <code>certbot</code> will <!-- raw HTML omitted -->not<!-- raw HTML omitted --> be confined to a restricted environment in the same way as normal snaps are.</p>
<p>The installation ends with a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">certbot 1.12.0 from Certbot Project <span class="o">(</span>certbot-eff✓<span class="o">)</span> installed
</code></pre></div><p>The snap executable for <code>certbot</code> is in the directory <code>/snap/bin</code>, which should be in your execution PATH. If you want to make extra sure that <code>certbot</code> is executable, then also create a symbolic link to <code>certbot</code> in your <code>/usr/bin</code> directory, which should definitely be in your PATH:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre></div><p>The symbolic link <code>/usr/bin/certbot</code> now points to the actual executable at <code>/snap/bin/certbot</code>.</p>
<p>Now you can invoke <code>certbot</code> to obtain your SSL certificate from the Let&rsquo;s Encrypt project:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">certbot --nginx 
</code></pre></div><p>The <code>--nginx</code> option tells <code>certbot</code> that Nginx is already running and available for use by <code>certbot</code> to validate your request.</p>
<p>You are asked to enter your email address in case Let&rsquo;s Encrypt has some urgent notices to send you:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Enter email address <span class="o">(</span>used <span class="k">for</span> urgent renewal and security notices<span class="o">)</span>
 <span class="o">(</span>Enter <span class="s1">&#39;c&#39;</span> to cancel<span class="o">)</span>:
</code></pre></div><p>Type your email address, and press <code>ENTER</code>.</p>
<p>You are asked to read and agree to the terms of service:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Please <span class="nb">read</span> the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.2-November-15-2017.pdf. You must
agree in order to register with the ACME server. Do you agree?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
<span class="o">(</span>Y<span class="o">)</span>es/<span class="o">(</span>N<span class="o">)</span>o:
</code></pre></div><p>Type <code>Y</code> and press <code>ENTER</code>.</p>
<p>You are asked if you want to share your email address with the Electronic Frontier Foundation:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing, once your first certificate is successfully issued, to
share your email address with the Electronic Frontier Foundation, a founding
partner of the Let<span class="s1">&#39;s Encrypt project and the non-profit organization that
</span><span class="s1">develops Certbot? We&#39;</span>d like to send you email about our work encrypting the web,
EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
<span class="o">(</span>Y<span class="o">)</span>es/<span class="o">(</span>N<span class="o">)</span>o:
</code></pre></div><p>Type <code>Y</code> or <code>N</code> as you prefer, and press <code>ENTER</code>.</p>
<p>You are asked to confirm which fully qualified domain name(s) you want an SSL certificate for:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Which names would you like to activate HTTPS <span class="k">for</span>?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: your_domain
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate numbers separated by commas and/or spaces, or leave input
blank to <span class="k">select</span> all options shown <span class="o">(</span>Enter <span class="s1">&#39;c&#39;</span> to cancel<span class="o">)</span>:
</code></pre></div><p>Type the number of your server&rsquo;s fully qualified domain name, which would be <code>1</code> in our example, and press <code>ENTER</code>.</p>
<p>The utility performs &ldquo;challenges&rdquo; to confirm that your domain name choice is legitimate. If all is well, you should see some closing messages. Certbot amends your site definition to supplement the existing HTTP server with an HTTPS server:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">Redirecting all traffic on port <span class="m">80</span> to ssl in /etc/nginx/sites-enabled/default

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations! You have successfully enabled https://your_domain
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</code></pre></div><p>You will then see some notes on the certificate and key locations:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"> - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/your_domain/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/your_domain/privkey.pem
   Your certificate will expire on 2021-05-18. To obtain a new or
   tweaked version of this certificate in the future, simply run
   certbot again. To non-interactively renew *all* of your
   certificates, run <span class="s2">&#34;certbot renew&#34;</span>
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let<span class="err">&#39;</span>s Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le


</code></pre></div><p>Finally, do a dry run to check that the renewal process will work in 90 days' time:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">certbot renew --dry-run
</code></pre></div><p>This should end with a message:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Congratulations, all simulated renewals succeeded:
  /etc/letsencrypt/live/your_domain/fullchain.pem <span class="o">(</span>success<span class="o">)</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</code></pre></div><p>Test your web server. In a browser, visit your fully qualified domain name (<code>https://your_domain</code>). You should see the <code>Welcome to nginx!</code> page.</p>
<p>Optionally, you can now add some content (HTML, CSS, etc.) to your camouflage website at <code>/var/www/html</code> to increase its realism.</p>
<h2 id="step-4--installing-go-language">Step 4 — Installing Go Language</h2>
<p>Go is a statically typed, compiled programming language designed at Google by Ken Thompson, Robert Griesemer, and Rob Pike. Ken Thompson designed and implemented the original Unix operating system.</p>
<p>In this step, you&rsquo;ll install the Go compiler on your server. You can determine the latest version from <a href="https://golang.org">https://golang.org</a>.</p>
<p>Start by downloading the latest version of Go. From the Go language website linked above, this is currently version 1.16. It may be higher when you read this tutorial.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">wget https://golang.org/dl/go1.16.linux-amd64.tar.gz
</code></pre></div><p>Extract the contents of the tarball into <code>/usr/local</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">tar -C /usr/local -xzf go1.16.linux-amd64.tar.gz
</code></pre></div><p>Include the Go binary in your current execution path:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/go/bin
</code></pre></div><p>This will be effective for the duration of your current SSH session. If you need to have Go in your execution path permanently, then add it to <code>/etc/profile</code>.</p>
<h2 id="step-5--downloading-mtg">Step 5 — Downloading Mtg</h2>
<p>Mtg is an MTProto implementation in the Go language that is intended to be lightweight, consuming as few resources as possible.</p>
<p>Before downloading Mtg, you will need to install <code>git</code> if it is not already on your system:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">apt install git -y
</code></pre></div><p>Then use <code>git</code> to clone the Mtg source code from GitHub:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/9seconds/mtg.git
</code></pre></div><p>This creates a directory <code>mtg</code> with the Mtg source code in it.</p>
<h2 id="step-6--building-mtg">Step 6 — Building Mtg</h2>
<p>Now you will use the Go language compiler to build Mtg. Change into the directory containing the Mtg source:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> mtg
</code></pre></div><p>Build the binary from source:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go build
</code></pre></div><p>You will see the dependencies being downloaded. The <code>mtg</code> executable is created within your current <code>mtg</code> directory.</p>
<p>Copy the <code>mtg</code> binary into your execution path:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cp mtg /usr/local/bin
</code></pre></div><h2 id="step-7--generating-secret">Step 7 — Generating Secret</h2>
<p>MTProto proxy servers require the user to know a &ldquo;secret&rdquo; to access them. Generate a secret with the command below. Replace <code>host.example.com</code> by your server&rsquo;s actual hostname (i.e., the fully qualified domain name, for which you create a DNS <code>A</code> record as one of the prerequisites).</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mtg generate-secret -c host.example.com tls
</code></pre></div><p>This returns a secret, which will begin with the prefix <code>ee</code>, indicating a fake TLS secret:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">ee0123456789abcdef...
</code></pre></div><p>Save the secret in a text editor on your PC, as you will need it later.</p>
<h2 id="step-8--reconfiguring-nginx">Step 8 — Reconfiguring Nginx</h2>
<p>You want Mtg to listen on port <code>443</code>. Therefore you will now edit the Nginx default host configuration file, <code>/etc/nginx/sites-available/default</code>, so that Nginx listens on port <code>993</code> instead of <code>443</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano /etc/nginx/sites-available/default
</code></pre></div><p>Amend the listening port in the <code>ssl</code> server block. Change the Nginx port from <code>443</code> to <code>993</code> for both IPv4 and IPv6:</p>
<div class="highlight"><pre class="chroma"><code class="language-nginx" data-lang="nginx">        <span class="k">listen</span> <span class="s">[::]:993</span> <span class="s">ssl</span> <span class="s">ipv6only=on</span><span class="p">;</span> <span class="c1"># managed by Certbot
</span><span class="c1"></span>        <span class="k">listen</span> <span class="mi">993</span> <span class="s">ssl</span><span class="p">;</span> <span class="c1"># managed by Certbot
</span></code></pre></div><p>Write the file out to disk, and exit the editor.</p>
<p>Restart Nginx with this new configuration:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">systemctl restart nginx
</code></pre></div><h2 id="step-9--configuring-mtg">Step 9 — Configuring Mtg</h2>
<p>Create a systemd service file for Mtg named <code>/usr/lib/systemd/system/mtg.service</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nano /usr/lib/systemd/system/mtg.service
</code></pre></div><p>Insert the template below, but substitute your actual secret instead of the placeholder <code>&lt;SECRET&gt;</code>. The angle brackets are just to indicate a substitutable variable and are not included in the final file. For<code>&lt;SERVER.IP&gt;</code> put the public IPv4 address of your server. Other possible parameters are documented in the <a href="https://github.com/9seconds/mtg/blob/master/README.md">https://github.com/9seconds/mtg/blob/master/README.md</a>.</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">[Unit]
Description=Telegram MTProto Proxy Server
Documentation=https://github.com/9seconds/mtg
Wants=network-online.target
After=network-online.target

[Service]
Restart=always
User=root
Group=root
ExecStart=/usr/local/bin/mtg run --cloak-port 993 -4 &lt;SERVER.IP&gt;:443 -b 0.0.0.0:443 &lt;SECRET&gt;

[Install]
WantedBy=multi-user.target
</code></pre></div><p>When you&rsquo;ve put in yout actual values, write the file out to disk, and exit the editor.</p>
<h2 id="step-10--starting-and-checking-mtg">Step 10 — Starting and Checking Mtg</h2>
<p>Run the Mtg service, <code>mtg</code>, after every reboot:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">systemctl <span class="nb">enable</span> mtg
</code></pre></div><p>Start the Mtg service now:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">systemctl start mtg
</code></pre></div><p>Check that <code>mtg</code> is active and running:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">systemctl status mtg
</code></pre></div><p>You should see a result such as:</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">mtg.service - Telegram MTProto Proxy Server
     Loaded: loaded (/lib/systemd/system/mtg.service; enabled; vendor preset: enabled)
     Active: active (running) since Thu 2021-02-18 12:18:05 UTC; 39s ago
       Docs: https://github.com/9seconds/mtg
   Main PID: 34363 (mtg)
      Tasks: 8 (limit: 1137)
     Memory: 6.9M
     CGroup: /system.slice/mtg.service
             └─34363 /usr/local/bin/mtg run --cloak-port 993 -4 &lt;SERVER.IP&gt;:443 -b 0.0.0.0:443 &lt;SECRET&gt;
</code></pre></div><p>If you want to review any messages for the systemd unit <code>mtg</code>, then issue the command:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">journalctl -u mtg
</code></pre></div><h2 id="step-11--testing">Step 11 — Testing</h2>
<p>Now work on your client device. We will use the example of an Android phone.</p>
<p>Before you go any further, test your camouflage web server. In an ordinary browser, visit your fully qualified domain name (<code>https://your_domain</code>). You should see the <code>Welcome to nginx!</code> page (or the realistic content, if you added some).</p>
<p>Now you know your camouflage web server is working, you can carry on.</p>
<p>We will illustrate the example of MTProxy on Android. Go to <strong>Settings</strong>. Tap <strong>Data and Storage</strong>. Scroll down and tap <strong>Proxy Settings</strong>.</p>
<p>Toggle <strong>Use Proxy</strong> to the ON position. Select the radio button for <strong>MTProto Proxy</strong>.</p>
<p>Enter the proxy details for your MTProto proxy. The information you need is:</p>
<ul>
<li>Server (<code>your_domain</code>)</li>
<li>Port (put <code>443</code>)</li>
<li>Secret (put the secret as generated, which begins with <code>ee</code> for a fake TLS proxy)</li>
</ul>
<p><img src="/images/telegram-proxy-setup.png" alt="Telegram proxy setup"></p>
<p>Press the check mark to save your settings.</p>
<p>Go back to the Proxy Settings screen. It will take a few seconds to connect to the proxy.</p>
<p>Test your connection with your friends and/or a group.</p>
<h2 id="step-12--sharing-the-secret">Step 12 — Sharing the Secret</h2>
<p>Now that everything is running, you can share the proxy with your friends. The information they need is the server (<code>your_domain</code>), the port (<code>443</code>), and the secret.</p>
<h2 id="conclusion">Conclusion</h2>
<p>You now have a camouflaged MTProto proxy server that you&rsquo;ve tested with Telegram Messenger.</p>
<p>You can read more about MTProto at <a href="https://core.telegram.org/mtproto">https://core.telegram.org/mtproto</a>. You can read the Mtg documentation at <a href="https://github.com/9seconds/mtg">https://github.com/9seconds/mtg</a>.</p>


        
          <div class="blog-tags">
            
              <a href="https://v2how.github.io/tags/telegram/">telegram</a>&nbsp;
            
              <a href="https://v2how.github.io/tags/mtproto/">mtproto</a>&nbsp;
            
              <a href="https://v2how.github.io/tags/server/">server</a>&nbsp;
            
              <a href="https://v2how.github.io/tags/ubuntu/">ubuntu</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f&amp;text=How%20to%20Build%20a%20Camouflaged%20Telegram%20MTProto%20Proxy%20Server%20on%20Ubuntu%2020.04&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f&amp;title=How%20to%20Build%20a%20Camouflaged%20Telegram%20MTProto%20Proxy%20Server%20on%20Ubuntu%2020.04" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f&amp;title=How%20to%20Build%20a%20Camouflaged%20Telegram%20MTProto%20Proxy%20Server%20on%20Ubuntu%2020.04" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f&amp;title=How%20to%20Build%20a%20Camouflaged%20Telegram%20MTProto%20Proxy%20Server%20on%20Ubuntu%2020.04" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fv2how.github.io%2fpost%2f2021-02-18-camouflage-telegram-mtproto-proxy-ubuntu-20-04%2f&amp;description=How%20to%20Build%20a%20Camouflaged%20Telegram%20MTProto%20Proxy%20Server%20on%20Ubuntu%2020.04" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/2021-02-19-tor-browser-standalone-tor-ubuntu-20-04-copy/">How to Install Tor Browser or Standalone Tor on Ubuntu 20.04</a></li>
                
                    <li><a href="/post/2021-02-15-v2ray-tor-on-ramp-ubuntu-20-04/">How to Build a V2Ray Tor On-Ramp on Ubuntu 20.04</a></li>
                
                    <li><a href="/post/2021-02-12-xray-vless-xtls-server-ubuntu-20-04/">How to Create an Xray VLESS XTLS Server on Ubuntu 20.04</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://v2how.github.io/post/2021-02-15-v2ray-tor-on-ramp-ubuntu-20-04/" data-toggle="tooltip" data-placement="top" title="How to Build a V2Ray Tor On-Ramp on Ubuntu 20.04">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://v2how.github.io/post/2021-02-19-tor-browser-standalone-tor-ubuntu-20-04-copy/" data-toggle="tooltip" data-placement="top" title="How to Install Tor Browser or Standalone Tor on Ubuntu 20.04">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:amyw32@protonmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Amy
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://v2how.github.io">v2how</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://v2how.github.io/js/main.js"></script>
<script src="https://v2how.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://v2how.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

